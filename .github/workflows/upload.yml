name: Upload to Backblaze B2

on:
  repository_dispatch:
    types: [b2-upload]

jobs:
  upload:
    runs-on: ubuntu-latest

    env:
      B2_KEY_ID: ${{ secrets.B2_KEY_ID }}
      B2_APPLICATION_KEY: ${{ secrets.B2_APPLICATION_KEY }}
      B2_BUCKET_NAME: ${{ secrets.B2_BUCKET_NAME }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          pip install b2sdk requests

      - name: Debug incoming payload
        run: |
          echo "ðŸ‘€ Payload received:"
          echo "Student URL: ${{ github.event.client_payload.student_url }}"
          echo "Professor URL: ${{ github.event.client_payload.professor_url }}"
          echo "Callback URL: ${{ github.event.client_payload.callback_url }}"
          echo "Student Email: ${{ github.event.client_payload.student_email }}"

      - name: Upload to B2
        run: |
          python upload_to_b2.py \
            "${{ github.event.client_payload.student_url }}" \
            "${{ github.event.client_payload.professor_url }}" \
            "${{ github.event.client_payload.callback_url }}" \
            "${{ github.event.client_payload.student_email }}"
