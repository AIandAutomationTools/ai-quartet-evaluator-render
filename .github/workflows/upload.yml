name: b2-upload

on:
  repository_dispatch:
    types: [upload-graph]

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run app to generate graph
        run: python main.py

      - name: Debug file exists
        run: |
          if [ -f output_graph.png ]; then
            echo "✅ output_graph.png exists"
          else
            echo "❌ output_graph.png missing"
            exit 1
          fi

      - name: Upload to Backblaze B2
        run: python upload_to_b2.py
        env:
          B2_KEY_ID: ${{ secrets.B2_KEY_ID }}
          B2_APPLICATION_KEY: ${{ secrets.B2_APPLICATION_KEY }}
          B2_BUCKET_NAME: ${{ secrets.B2_BUCKET_NAME }}
